# aws-cognito-api-lambda-sam

The purpose of this project is to demonstrate the usage of serverless AWS services - Cognito, API Gateway and Lambda to create a simple API method that requires authentication.  
AWS SAM framework is used to facilitate application deployment.

## Tech Stack
JDK 21, AWS SDK, JUnit 5, Mockito, GSON, Maven, AWS SAM

## Description
API Gateway `user-api-gateway` exposes three POST methods for user authorization via Amazon Cognito:
 - `/register` - takes user's e-mail, password and name, and triggers `RegisterUser` function.
The function will create a user in the Cognito user pool and send to user an e-mail with a verification code.
 - `/confirm` - takes user's e-mail and verification code, and triggers `ConfirmUser` function.
The function marks the user as confirmed in the Cognito user pool, and the user can login.
 - `/login` - takes user's e-mail and password and triggers `LoginUser` function.
The function will call Cognito's login method and return JWT tokens (id, access and refresh) generated by the Cognito user pool.

API Gateway `hello-api-gateway` exposes GET method integrated with `SayHello` function.
The method can be invoked only by an authenticated user from the Cognito user pool.
The method requires a valid `idToken` in the Authorization header. 
After successful token validation `SayHello` function will be called.

Everything is depicted on the diagram bellow. 
AWS resources are defined in the `template.yaml` file.

## Architecture diagram

![Alt text](./resources/aws-diagram.png?raw=true)

## Build and deployment
To build and deploy run the following in a shell:

```bash
sam validate
sam build
sam deploy --guided
```
The first command will validate the template file.  
The second command will build the source of your application.  
The third command will package and deploy the application to AWS, with a series of prompts.

## Testing

1. Register a user
    ```bash
    curl -d '{"email": "{email-value}", "password": "{password-value}", "name": "{name-value}"}' -H 'Content-Type: application/json' {CreateUserEndpoint}
    ```
    Response example:
    ```json
    {"isSuccessful":true,"statusCode":200,"cognitoUserId":"...","isConfirmed":false}
     ```

2. Confirm the user:
   ```bash
   curl -d '{"email": "{email-value}", "code": "{verification-code-value}"}' -H 'Content-Type: application/json' {ConfirmUserEndpoint}
   ```
   Response example:
    ```json
    {"isSuccessful":true,"statusCode":200}
    ```
3. Login the user
    ```bash
    curl -d '{"email": "{email-value}", "password": "{password-value}"}' -H 'Content-Type: application/json' {LoginUserEndpoint}
    ```
    
    Response example:
    ```json
    {"isSuccessful":true, "statusCode":200, "idToken":"...", "accessToken": "...", "refreshToken": "..."}
    ```
4. Call the protected Hello API method
    ```bash
    curl --header 'Authorization: {idToken-value}' {SayHelloEndpoint}
    ```

   Response example:
    ```json
    { "message": "Hello from Lambda" }
    ```

## Cleanup
To delete the application (the created stack) from an AWS account, run the following:

```bash
sam delete --stack-name name-of-the-stack
```